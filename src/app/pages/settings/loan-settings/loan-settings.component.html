<div class="card bg-secondary shadow">
  <div class="card-header bg-white border-0">
    <div class="row align-items-center">
      <div class="col-8">
        <h3 class="mb-0">Loan Settings</h3>
      </div>
    </div>
  </div>
  <div class="card-body">
    <!-- Fixed Interest Rate Section -->
    <h6 class="heading-small text-muted mb-4">Fixed Interest Rate</h6>
    <div class="pl-lg-4">
      <form [formGroup]="interestRateForm" (ngSubmit)="onUpdateRate()" class="mb-5" *ngIf="interestRateForm">
        <div class="form-row align-items-center">
          <div class="col-md-4">
            <div class="form-group">
              <label class="form-control-label">Interest Rate</label>
              <div class="input-group input-group-alternative">
                <div class="input-group-prepend">
                  <span class="input-group-text"><i class="ni ni-percent"></i></span>
                </div>
                <input 
                  type="number" 
                  class="form-control form-control-alternative" 
                  formControlName="rate" 
                  placeholder="Enter interest rate"
                  step="0.1"
                  min="0.1"
                  max="100">
              </div>
              <small class="text-danger" *ngIf="interestRateForm.get('rate')?.touched && interestRateForm.get('rate')?.errors">
                <span *ngIf="interestRateForm.get('rate')?.hasError('required')">Interest rate is required</span>
                <span *ngIf="interestRateForm.get('rate')?.hasError('min')">Rate must be at least 0.1%</span>
                <span *ngIf="interestRateForm.get('rate')?.hasError('max')">Rate cannot exceed 100%</span>
              </small>
            </div>
          </div>
          <div class="col-auto mt-4 pt-2">
            <button type="submit" class="btn btn-sm btn-primary" [disabled]="isSubmitting || interestRateForm.invalid">
              <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm mr-2" role="status" aria-hidden="true"></span>
              Update Rate
            </button>
          </div>
        </div>
      </form>
    </div>

    <hr class="my-4">

    <!-- Add New Tenure Form -->
    <h6 class="heading-small text-muted mb-4">Add New Tenure</h6>
    <div class="pl-lg-4">
      <form [formGroup]="tenureForm" (ngSubmit)="onAddTenure()" class="mb-5" *ngIf="tenureForm">
        <div class="form-row">
          <!-- Tenure Months -->
          <div class="col-md-4">
            <div class="form-group">
              <label class="form-control-label">Tenure (Months)</label>
              <div class="input-group input-group-alternative">
                <div class="input-group-prepend">
                  <span class="input-group-text"><i class="ni ni-watch-time"></i></span>
                </div>
                <input 
                  type="number" 
                  class="form-control form-control-alternative" 
                  formControlName="tenureMonths" 
                  placeholder="Enter months"
                  min="1"
                  max="360">
                <div class="input-group-append">
                  <span class="input-group-text">months</span>
                </div>
              </div>
              <small class="text-danger" *ngIf="tenureForm.get('tenureMonths')?.touched && tenureForm.get('tenureMonths')?.errors">
                <span *ngIf="tenureForm.get('tenureMonths')?.hasError('required')">Months is required</span>
                <span *ngIf="tenureForm.get('tenureMonths')?.hasError('min')">Minimum 1 month</span>
                <span *ngIf="tenureForm.get('tenureMonths')?.hasError('max')">Maximum 360 months</span>
              </small>
            </div>
          </div>

          <!-- Min Amount -->
          <div class="col-md-4">
            <div class="form-group">
              <label class="form-control-label">Minimum Amount (₦)</label>
              <div class="input-group input-group-alternative">
                <div class="input-group-prepend">
                  <span class="input-group-text">₦</span>
                </div>
                <input 
                  type="number" 
                  class="form-control form-control-alternative" 
                  formControlName="minAmount" 
                  placeholder="Minimum amount"
                  min="0"
                  step="0.01">
              </div>
              <small class="text-danger" *ngIf="tenureForm.get('minAmount')?.touched && tenureForm.get('minAmount')?.errors">
                <span *ngIf="tenureForm.get('minAmount')?.hasError('required')">Minimum amount is required</span>
                <span *ngIf="tenureForm.get('minAmount')?.hasError('min')">Must be 0 or more</span>
              </small>
            </div>
          </div>

          <!-- Max Amount -->
          <div class="col-md-4">
            <div class="form-group">
              <label class="form-control-label">Maximum Amount (₦)</label>
              <div class="input-group input-group-alternative">
                <div class="input-group-prepend">
                  <span class="input-group-text">₦</span>
                </div>
                <input 
                  type="number" 
                  class="form-control form-control-alternative" 
                  formControlName="maxAmount" 
                  placeholder="Maximum amount"
                  min="0"
                  step="0.01">
              </div>
              <small class="text-danger" *ngIf="tenureForm.get('maxAmount')?.touched && tenureForm.get('maxAmount')?.errors">
                <span *ngIf="tenureForm.get('maxAmount')?.hasError('required')">Maximum amount is required</span>
                <span *ngIf="tenureForm.get('maxAmount')?.hasError('min')">Must be 0 or more</span>
              </small>
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="col-12 text-right mt-3">
            <button type="submit" class="btn btn-sm btn-primary" [disabled]="isSubmitting || tenureForm.invalid">
              <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm mr-2" role="status" aria-hidden="true"></span>
              Add Tenure
            </button>
          </div>
        </div>
      </form>
    </div>

    <hr class="my-4">

    <!-- Loan Tenures Section -->
    <h6 class="heading-small text-muted mb-4">Loan Tenures</h6>
    <div class="pl-lg-4">
      <div *ngIf="isLoading" class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
          <span class="sr-only">Loading...</span>
        </div>
      </div>

      <div *ngIf="!isLoading">
        <div *ngIf="!dataSource?.data?.length" class="text-center py-4">
          <i class="ni ni-collection text-muted" style="font-size: 2rem;"></i>
          <p class="mt-2 mb-0">No tenures found. Add a new tenure to get started.</p>
        </div>

        <div *ngIf="dataSource?.data?.length" class="table-responsive">
          <table mat-table [dataSource]="dataSource" class="mat-elevation-z8 w-100">
            <!-- Tenure Column -->
            <ng-container matColumnDef="tenureMonths">
              <th mat-header-cell *matHeaderCellDef>Tenure (Months)</th>
              <td mat-cell *matCellDef="let tenure">
                <div class="media align-items-center">
                  <div class="media-body">
                    <span class="mb-0 text-sm">{{ tenure.tenureMonths }} months</span>
                  </div>
                </div>
              </td>
            </ng-container>

            <!-- Min Amount Column -->
            <ng-container matColumnDef="minAmount">
              <th mat-header-cell *matHeaderCellDef>Min Amount (₦)</th>
              <td mat-cell *matCellDef="let tenure">
                <span class="text-sm">{{ tenure.minAmount | number:'1.2-2' }}</span>
              </td>
            </ng-container>

            <!-- Max Amount Column -->
            <ng-container matColumnDef="maxAmount">
              <th mat-header-cell *matHeaderCellDef>Max Amount (₦)</th>
              <td mat-cell *matCellDef="let tenure">
                <span class="text-sm">{{ tenure.maxAmount | number:'1.2-2' }}</span>
              </td>
            </ng-container>

            <!-- Status Column -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let tenure">
                <span class="badge badge-dot mr-4">
                  <i [ngClass]="tenure.isActive ? 'bg-success' : 'bg-warning'"></i>
                  {{ tenure.isActive ? 'Active' : 'Inactive' }}
                </span>
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef class="text-right">Actions</th>
              <td mat-cell *matCellDef="let tenure" class="text-right">
                <div class="dropdown">
                  <button mat-icon-button [matMenuTriggerFor]="menu">
                    <i class="fas fa-ellipsis-v"></i>
                  </button>
                  <mat-menu #menu="matMenu">
                    <button mat-menu-item (click)="onToggleTenureStatus(tenure)" [disabled]="isUpdatingStatus === tenure.id">
                      <i class="ni mr-2" [class.ni-check-bold]="!tenure.isActive" [class.ni-fat-remove]="tenure.isActive"></i>
                      {{ tenure.isActive ? 'Deactivate' : 'Activate' }}
                    </button>
                    <button mat-menu-item (click)="onDeleteTenure(tenure)" class="text-danger">
                      <i class="ni ni-fat-remove mr-2"></i> Delete
                    </button>
                  </mat-menu>
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
          
          <mat-paginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
        </div>
      </div>
    </div>
  </div>
</div>
